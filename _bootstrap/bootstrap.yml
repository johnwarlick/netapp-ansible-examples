---
- name: Bootstrap AWX 
  hosts: localhost
  gather_facts: no
  collections:
    - awx.awx
    - community.docker
  vars: 
    tower_host: http://awx.demo.netapp.com
    tower_username: admin
    tower_password: "{{ lookup('env', 'TOWER_PASSWORD') }}"  
    project_name: Provisioning Demo
    inventory_name: "{{ project_name }} Inventory"
    organization: Default
    config: 
      tower_cli: 
        file: .tower_cli.cfg
        path: ~/
      env:
        file: .env
        path: "{{ playbook_dir }}/app/lib"
  tasks:
  - name: Create a new token using username/password
    tower_token:
      scope: "write"
      state: present
      tower_host: "{{ tower_host }}"
      tower_username: "{{ tower_username }}"
      tower_password: "{{ tower_password }}"
  - name: Get tower CLI config file
    template:
      src: "{{ config.tower_cli.file }}.j2"
      dest: "{{ config.tower_cli.path }}{{ config.tower_cli.file }}"    
    vars: 
      tower_oauth_token: "{{ tower_token.token }}"  
  - name: Get mock provisioning app .env config file
    template:
      src: "{{ config.env.file }}.j2"
      dest: "{{ config.env.path }}{{ config.env.file }}"    
    vars: 
      tower_oauth_token: "{{ tower_token.token }}"  
  - name: Add Galaxy/Automation Hub Variable to Jobs -> Settings
    tower_settings:
      name: PRIMARY_GALAXY_URL
      value: https://galaxy.ansible.com
  - name: Add ONTAP Cluster Admin custom credential type
    tower_credential_type:
      name: ONTAP Cluster Admin
      kind: cloud
      inputs: 
        fields:
          - id: ontap_username
            type: string
            label: ONTAP Username
          - id: ontap_password
            type: string
            label: ONTAP Password
            secret: true 
      injectors: 
        extra_vars:
          ontap_password: "{%raw%}{{ ontap_password }}{%endraw%}"
          ontap_username: "{%raw%}{{ ontap_username }}{%endraw%}"
      state: present    
  - name: Add ONTAP Admin Cluster credential
    tower_credential:
      name: ONTAP Admin
      credential_type: ONTAP Cluster Admin
      organization: Default
      inputs:
        ontap_username: admin
        ontap_password: "{{ lookup('env', 'ONTAP_PASSWORD') }}" 
  - name: Add AWX host credential
    tower_credential:
      name: AWX Host
      credential_type: Machine
      organization: Default
      inputs:
        username: root
        password: "{{ tower_password }}" 
  - name: Add this repo as a project in AWX
    tower_project:
      name: "{{ project_name }}"
      description: "For demoing ONTAP provisioning workflows in Ansible"
      organization: "{{ organization }}"
      scm_type: git
      scm_url: https://github.com/johnwarlick/netapp-ontap-ansible-awx-demo
      scm_update_on_launch: yes
      state: present
  - name: Add inventory 
    tower_inventory:
      name: "{{ inventory_name }}"
      organization: "{{ organization }}"
      state: present
  - name: Add Inventory Source using project's inventory file
    tower_inventory_source:
      name: "{{ inventory_name }}"
      source: scm
      source_project: "{{ project_name }}"
      source_path: inventory
      inventory: "{{ inventory_name }}"
      update_on_project_update: yes
  - name: Add Create Volume job template 
    tower_job_template:
      name: "ontap_create_volume"
      job_type: "run"
      ask_limit_on_launch: yes
      ask_variables_on_launch: yes
      inventory: "{{ inventory_name }}"
      project: "{{ project_name }}"
      playbook: "create_volume.yml"
      credentials:
        - "ONTAP Admin"
      state: "present"
  - name: Install docker-compose 
    ansible.builtin.pip:
      name: docker-compose
  - name: Start provisioning app
    community.docker.docker_compose:
      project_src: app
    register: docker_output
  - ansible.builtin.debug:
      var: docker_output
